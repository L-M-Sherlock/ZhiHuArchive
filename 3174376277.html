<!DOCTYPE html>
<html lang="zh">
<head>
<title>Githubä¸Šæœ‰å“ªäº›Rustå†™çš„çŸ¥åé¡¹ç›®ï¼Ÿ - @Thoughts Memo | ZhiHu Archive</title>
<meta charset="UTF-8">
<meta property="og:type" content="website">
<meta property="og:title" content="Githubä¸Šæœ‰å“ªäº›Rustå†™çš„çŸ¥åé¡¹ç›®ï¼Ÿ - @Thoughts Memo | ZhiHu Archive">
<meta property="og:site_name" content="ZhiHu Archive for Thoughts Memo">
<meta property="og:description" itemprop="description" content="Ankiï¼ˆä¸€æ¬¾å¼€æºçš„é—´éš”é‡å¤è½¯ä»¶ï¼‰å¤§æ¦‚ç®—åŠä¸ªå§ï¼š [å›¾ç‰‡] è¯­è¨€æˆåˆ†æå…¶å¤æ‚ï¼ˆRust å’Œ Python åŠ èµ·æ¥å äº†å››åˆ†ä¹‹ä¸‰ä»¥ä¸Šï¼‰ï¼š [å›¾ç‰‡] ä»¥å‰çš„ä¸»ä½“æ˜¯ PyQtï¼Œç°åœ¨å·²ç»å°†å¤§éƒ¨åˆ†åº•å±‚ä»£ç ç”¨ Rust é‡å†™äº†ã€‚ æ‹œå®ƒæ‰€èµï¼Œæˆ‘æœ¬æ¥ä¸€ä¸ªè‡­å†™ Python çš„ï¼Œç°åœ¨å¤©å¤©è¢« Rust ç²¾ç¥æ³¨å…¥ã€‚ ä¸è¿‡è¿˜å¥½æœ‰ GPT-4ï¼Œå¯ä»¥å¸®æˆ‘å†™ Rust ä»£ç ï¼Œè€Œä¸”æ•ˆæœè¿˜ä¸é”™ï¼š [å›¾ç‰‡] [å›¾ç‰‡] [å›¾ç‰‡] ä¸€ä¸ªæ™šä¸Šå°±å†™å®Œäº†ä» Anki çš„ sqlite æ•°æ®åº“æ„å»º FSRS æ•°æ®é›†çš„ä»£ç ï¼š [å›¾ç‰‡] use chrono::prelude::*; use chrono_tz::Tz; use râ€¦">
<meta property="og:url" content="https://www.zhihu.com/question/512163948/answer/3174376277">
<meta name="description" content="Ankiï¼ˆä¸€æ¬¾å¼€æºçš„é—´éš”é‡å¤è½¯ä»¶ï¼‰å¤§æ¦‚ç®—åŠä¸ªå§ï¼š [å›¾ç‰‡] è¯­è¨€æˆåˆ†æå…¶å¤æ‚ï¼ˆRust å’Œ Python åŠ èµ·æ¥å äº†å››åˆ†ä¹‹ä¸‰ä»¥ä¸Šï¼‰ï¼š [å›¾ç‰‡] ä»¥å‰çš„ä¸»ä½“æ˜¯ PyQtï¼Œç°åœ¨å·²ç»å°†å¤§éƒ¨åˆ†åº•å±‚ä»£ç ç”¨ Rust é‡å†™äº†ã€‚ æ‹œå®ƒæ‰€èµï¼Œæˆ‘æœ¬æ¥ä¸€ä¸ªè‡­å†™ Python çš„ï¼Œç°åœ¨å¤©å¤©è¢« Rust ç²¾ç¥æ³¨å…¥ã€‚ ä¸è¿‡è¿˜å¥½æœ‰ GPT-4ï¼Œå¯ä»¥å¸®æˆ‘å†™ Rust ä»£ç ï¼Œè€Œä¸”æ•ˆæœè¿˜ä¸é”™ï¼š [å›¾ç‰‡] [å›¾ç‰‡] [å›¾ç‰‡] ä¸€ä¸ªæ™šä¸Šå°±å†™å®Œäº†ä» Anki çš„ sqlite æ•°æ®åº“æ„å»º FSRS æ•°æ®é›†çš„ä»£ç ï¼š [å›¾ç‰‡] use chrono::prelude::*; use chrono_tz::Tz; use râ€¦">
<meta data-pagefind-meta="title" content="Githubä¸Šæœ‰å“ªäº›Rustå†™çš„çŸ¥åé¡¹ç›®ï¼Ÿ">
<link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/yue.css@0.4.0/yue.css">
<meta property="twitter:card" content="summary">
<meta name="twitter:title" content="Githubä¸Šæœ‰å“ªäº›Rustå†™çš„çŸ¥åé¡¹ç›®ï¼Ÿ - @Thoughts Memo | ZhiHu Archive">
<meta name="twitter:description" content="Ankiï¼ˆä¸€æ¬¾å¼€æºçš„é—´éš”é‡å¤è½¯ä»¶ï¼‰å¤§æ¦‚ç®—åŠä¸ªå§ï¼š [å›¾ç‰‡] è¯­è¨€æˆåˆ†æå…¶å¤æ‚ï¼ˆRust å’Œ Python åŠ èµ·æ¥å äº†å››åˆ†ä¹‹ä¸‰ä»¥ä¸Šï¼‰ï¼š [å›¾ç‰‡] ä»¥å‰çš„ä¸»ä½“æ˜¯ PyQtï¼Œç°åœ¨å·²ç»å°†å¤§éƒ¨åˆ†åº•å±‚ä»£ç ç”¨ Rust é‡å†™äº†ã€‚ æ‹œå®ƒæ‰€èµï¼Œæˆ‘æœ¬æ¥ä¸€ä¸ªè‡­å†™ Python çš„ï¼Œç°åœ¨å¤©å¤©è¢« Rust ç²¾ç¥æ³¨å…¥ã€‚ ä¸è¿‡è¿˜å¥½æœ‰ GPT-4ï¼Œå¯ä»¥å¸®æˆ‘å†™ Rust ä»£ç ï¼Œè€Œä¸”æ•ˆæœè¿˜ä¸é”™ï¼š [å›¾ç‰‡] [å›¾ç‰‡] [å›¾ç‰‡] ä¸€ä¸ªæ™šä¸Šå°±å†™å®Œäº†ä» Anki çš„ sqlite æ•°æ®åº“æ„å»º FSRS æ•°æ®é›†çš„ä»£ç ï¼š [å›¾ç‰‡] use chrono::prelude::*; use chrono_tz::Tz; use râ€¦">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<meta name="google-site-verification" content="U7ZAFUgGNK60mmMqaRygg5vy-k8pwbPbDFXNjDCu7Xk" />
<link rel="alternate" type="application/rss+xml" title="ZhiHu Archive for Thoughts Memo" href="https://l-m-sherlock.github.io/ZhiHuArchive/feed.xml">
<script>
const redirect = false;
if (redirect) {
window.location.replace("https://www.zhihu.com/question/512163948/answer/3174376277");
}
</script>
<style>
img {
vertical-align: middle;
}
figure img {
width: 100%;
}
figure {
margin: 1.4em 0;
}
.author {
display: flex;
gap: 1em;
align-items: center;
}
#avatar {
width: 100px;
height: 100px;
}
.author > div {
flex: 1;
}
a {
color: #2563eb;
text-decoration: none;
border-bottom: 1px solid rgba(37, 99, 235, 0.3);
border-radius: 4px;
padding: 0 0.1em;
transition: color 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
}
a:hover,
a:focus-visible {
color: #1d4ed8;
border-bottom-color: rgba(29, 78, 216, 0.6);
background-color: rgba(37, 99, 235, 0.08);
}
a:focus-visible {
outline: none;
box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
}
a[data-draft-type="link-card"] {
   display: block;
   border-bottom: none;
   padding: 0;
   background: none;
}
.references {
font-size: 0.85em;
}
.formula-display {
display: block;
text-align: center;
}
</style>
</head>
<body style="max-width: 1000px; margin: 0 auto; padding: 0 1em 0 1em;" class="yue">
<p data-pagefind-ignore><a href="./">â† è¿”å›ç›®å½•</a></p>
<hr>
<header>
<h1><a href="https://www.zhihu.com/question/512163948/answer/3174376277" target="_blank" rel="noopener noreferrer">Githubä¸Šæœ‰å“ªäº›Rustå†™çš„çŸ¥åé¡¹ç›®ï¼Ÿ</a></h1>
<div class="author">
<img class="avatar" id="avatar" src="https://picx.zhimg.com/v2-d571786b77078321f5f6ef92f4967877_l.jpg?source=2c26e567" />
<div>
<h2 rel="author">
<a href="https://www.zhihu.com/people/4c592f496dc33822b560b382907ff1d0" target="_blank" rel="noopener noreferrer">@Thoughts Memo</a>
</h2>
<p>å­¦æ ¡â‰ æ•™è‚²â‰ æŠ€èƒ½ï¼›æ–‡å‡­æº¢ä»·=80%ä¿¡å·ä¼ é€’+20%äººåŠ›èµ„æœ¬</p>
</div>
</div>
<time datetime="2023-08-20T09:21:44">å‘è¡¨äº 2023å¹´08æœˆ20æ—¥</time>
<p rel="stats"style="color: #999; font-size: 0.9em;">196 ğŸ‘ / 23 ğŸ’¬</p>
</header>
<article data-pagefind-body>

<p data-pid="hnIBpPBv">Ankiï¼ˆä¸€æ¬¾å¼€æºçš„é—´éš”é‡å¤è½¯ä»¶ï¼‰å¤§æ¦‚ç®—åŠä¸ªå§ï¼š</p><figure data-size="normal"><noscript><img class="origin_image zh-lightbox-thumb" data-caption="" data-default-watermark-src="https://pic1.zhimg.com/50/v2-48dd2b4504013f93fd5f6395a26386ce_720w.jpg?source=2c26e567" data-original="https://pic1.zhimg.com/v2-d13632ee8b2382afeaeff61ea471a691_r.jpg?source=2c26e567" data-original-token="v2-d13632ee8b2382afeaeff61ea471a691" data-rawheight="499" data-rawwidth="880" data-size="normal" src="https://picx.zhimg.com/50/v2-d13632ee8b2382afeaeff61ea471a691_720w.jpg?source=2c26e567" width="880"/></noscript><img class="origin_image zh-lightbox-thumb lazy" data-caption="" data-default-watermark-src="https://pic1.zhimg.com/50/v2-48dd2b4504013f93fd5f6395a26386ce_720w.jpg?source=2c26e567" data-original="https://pic1.zhimg.com/v2-d13632ee8b2382afeaeff61ea471a691_r.jpg?source=2c26e567" data-original-token="v2-d13632ee8b2382afeaeff61ea471a691" data-rawheight="499" data-rawwidth="880" data-size="normal" src="https://picx.zhimg.com/50/v2-d13632ee8b2382afeaeff61ea471a691_720w.jpg?source=2c26e567" width="880"/></figure><p data-pid="7iiBhNet">è¯­è¨€æˆåˆ†æå…¶å¤æ‚ï¼ˆRust å’Œ Python åŠ èµ·æ¥å äº†å››åˆ†ä¹‹ä¸‰ä»¥ä¸Šï¼‰ï¼š</p><figure data-size="normal"><noscript><img class="content_image" data-caption="" data-default-watermark-src="https://pica.zhimg.com/50/v2-5875e1afa43daf199c497988719b649f_720w.jpg?source=2c26e567" data-original-token="v2-72700e657aab48dba58d6c7d159b16a5" data-rawheight="377" data-rawwidth="337" data-size="normal" src="https://picx.zhimg.com/50/v2-72700e657aab48dba58d6c7d159b16a5_720w.jpg?source=2c26e567" width="337"/></noscript><img class="content_image lazy" data-caption="" data-default-watermark-src="https://pica.zhimg.com/50/v2-5875e1afa43daf199c497988719b649f_720w.jpg?source=2c26e567" data-original-token="v2-72700e657aab48dba58d6c7d159b16a5" data-rawheight="377" data-rawwidth="337" data-size="normal" src="https://picx.zhimg.com/50/v2-72700e657aab48dba58d6c7d159b16a5_720w.jpg?source=2c26e567" width="337"/></figure><p data-pid="1mkRwrya">ä»¥å‰çš„ä¸»ä½“æ˜¯ PyQtï¼Œç°åœ¨å·²ç»å°†å¤§éƒ¨åˆ†åº•å±‚ä»£ç ç”¨ Rust é‡å†™äº†ã€‚</p><p data-pid="hw0FOYp3">æ‹œå®ƒæ‰€èµï¼Œæˆ‘æœ¬æ¥ä¸€ä¸ªè‡­å†™ Python çš„ï¼Œç°åœ¨å¤©å¤©è¢« Rust ç²¾ç¥æ³¨å…¥ã€‚</p><p data-pid="FeLBBU29">ä¸è¿‡è¿˜å¥½æœ‰ GPT-4ï¼Œå¯ä»¥å¸®æˆ‘å†™ Rust ä»£ç ï¼Œè€Œä¸”æ•ˆæœè¿˜ä¸é”™ï¼š</p><figure data-size="normal"><noscript><img class="origin_image zh-lightbox-thumb" data-caption="" data-default-watermark-src="https://pica.zhimg.com/50/v2-68976a0438f157750911c44d08518c42_720w.jpg?source=2c26e567" data-original="https://picx.zhimg.com/v2-fd2a09f165e1592f0706e9f41e4792c2_r.jpg?source=2c26e567" data-original-token="v2-fd2a09f165e1592f0706e9f41e4792c2" data-rawheight="613" data-rawwidth="922" data-size="normal" src="https://picx.zhimg.com/50/v2-fd2a09f165e1592f0706e9f41e4792c2_720w.jpg?source=2c26e567" width="922"/></noscript><img class="origin_image zh-lightbox-thumb lazy" data-caption="" data-default-watermark-src="https://pica.zhimg.com/50/v2-68976a0438f157750911c44d08518c42_720w.jpg?source=2c26e567" data-original="https://picx.zhimg.com/v2-fd2a09f165e1592f0706e9f41e4792c2_r.jpg?source=2c26e567" data-original-token="v2-fd2a09f165e1592f0706e9f41e4792c2" data-rawheight="613" data-rawwidth="922" data-size="normal" src="https://picx.zhimg.com/50/v2-fd2a09f165e1592f0706e9f41e4792c2_720w.jpg?source=2c26e567" width="922"/></figure><figure data-size="normal"><noscript><img class="origin_image zh-lightbox-thumb" data-caption="" data-default-watermark-src="https://pic1.zhimg.com/50/v2-10893eb2cf3047432cedeac976d424e0_720w.jpg?source=2c26e567" data-original="https://pic1.zhimg.com/v2-e1c6d8710415475bf8678c8227138798_r.jpg?source=2c26e567" data-original-token="v2-e1c6d8710415475bf8678c8227138798" data-rawheight="539" data-rawwidth="751" data-size="normal" src="https://pica.zhimg.com/50/v2-e1c6d8710415475bf8678c8227138798_720w.jpg?source=2c26e567" width="751"/></noscript><img class="origin_image zh-lightbox-thumb lazy" data-caption="" data-default-watermark-src="https://pic1.zhimg.com/50/v2-10893eb2cf3047432cedeac976d424e0_720w.jpg?source=2c26e567" data-original="https://pic1.zhimg.com/v2-e1c6d8710415475bf8678c8227138798_r.jpg?source=2c26e567" data-original-token="v2-e1c6d8710415475bf8678c8227138798" data-rawheight="539" data-rawwidth="751" data-size="normal" src="https://pica.zhimg.com/50/v2-e1c6d8710415475bf8678c8227138798_720w.jpg?source=2c26e567" width="751"/></figure><figure data-size="normal"><noscript><img class="origin_image zh-lightbox-thumb" data-caption="" data-default-watermark-src="https://picx.zhimg.com/50/v2-d06455b42fcfc149a2a3de54ffdd3fc0_720w.jpg?source=2c26e567" data-original="https://picx.zhimg.com/v2-c237965a0b95a0c3474d268e6d24809b_r.jpg?source=2c26e567" data-original-token="v2-c237965a0b95a0c3474d268e6d24809b" data-rawheight="498" data-rawwidth="751" data-size="normal" src="https://picx.zhimg.com/50/v2-c237965a0b95a0c3474d268e6d24809b_720w.jpg?source=2c26e567" width="751"/></noscript><img class="origin_image zh-lightbox-thumb lazy" data-caption="" data-default-watermark-src="https://picx.zhimg.com/50/v2-d06455b42fcfc149a2a3de54ffdd3fc0_720w.jpg?source=2c26e567" data-original="https://picx.zhimg.com/v2-c237965a0b95a0c3474d268e6d24809b_r.jpg?source=2c26e567" data-original-token="v2-c237965a0b95a0c3474d268e6d24809b" data-rawheight="498" data-rawwidth="751" data-size="normal" src="https://picx.zhimg.com/50/v2-c237965a0b95a0c3474d268e6d24809b_720w.jpg?source=2c26e567" width="751"/></figure><p data-pid="NxQWs3Dy">ä¸€ä¸ªæ™šä¸Šå°±å†™å®Œäº†ä» Anki çš„ sqlite æ•°æ®åº“æ„å»º FSRS æ•°æ®é›†çš„ä»£ç ï¼š</p><figure data-size="normal"><noscript><img class="origin_image zh-lightbox-thumb" data-caption="" data-default-watermark-src="https://pic1.zhimg.com/50/v2-05685a65cac0f999bd4be68f918b4c57_720w.jpg?source=2c26e567" data-original="https://picx.zhimg.com/v2-f58256354e174c24245a859d4dfdcbc0_r.jpg?source=2c26e567" data-original-token="v2-f58256354e174c24245a859d4dfdcbc0" data-rawheight="404" data-rawwidth="1301" data-size="normal" src="https://picx.zhimg.com/50/v2-f58256354e174c24245a859d4dfdcbc0_720w.jpg?source=2c26e567" width="1301"/></noscript><img class="origin_image zh-lightbox-thumb lazy" data-caption="" data-default-watermark-src="https://pic1.zhimg.com/50/v2-05685a65cac0f999bd4be68f918b4c57_720w.jpg?source=2c26e567" data-original="https://picx.zhimg.com/v2-f58256354e174c24245a859d4dfdcbc0_r.jpg?source=2c26e567" data-original-token="v2-f58256354e174c24245a859d4dfdcbc0" data-rawheight="404" data-rawwidth="1301" data-size="normal" src="https://picx.zhimg.com/50/v2-f58256354e174c24245a859d4dfdcbc0_720w.jpg?source=2c26e567" width="1301"/></figure><div class="highlight"><pre><code class="language-rust"><span class="k">use</span><span class="w"> </span><span class="n">chrono</span>::<span class="n">prelude</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">chrono_tz</span>::<span class="n">Tz</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">rusqlite</span>::<span class="p">{</span><span class="n">Connection</span><span class="p">,</span><span class="w"> </span><span class="nb">Result</span><span class="p">,</span><span class="w"> </span><span class="n">Row</span><span class="p">};</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">dataset</span>::<span class="n">FSRSItem</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cp">#[derive(Debug)]</span><span class="w">
</span><span class="w"></span><span class="k">struct</span> <span class="nc">RevlogEntry</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">id</span>: <span class="kt">i64</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">cid</span>: <span class="kt">i64</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">usn</span>: <span class="kt">i64</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">button_chosen</span>: <span class="kt">i32</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">interval</span>: <span class="kt">i64</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">last_interval</span>: <span class="kt">i64</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">ease_factor</span>: <span class="kt">i64</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">taken_millis</span>: <span class="kt">i64</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">review_kind</span>: <span class="kt">i64</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">delta_t</span>: <span class="kt">i32</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">i</span>: <span class="kt">usize</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">r_history</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">t_history</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">row_to_revlog_entry</span><span class="p">(</span><span class="n">row</span>: <span class="kp">&amp;</span><span class="nc">Row</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="nb">Ok</span><span class="p">(</span><span class="n">RevlogEntry</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">id</span>: <span class="nc">row</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">cid</span>: <span class="nc">row</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">?</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">usn</span>: <span class="nc">row</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">?</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">button_chosen</span>: <span class="nc">row</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">?</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">interval</span>: <span class="nc">row</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">?</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">last_interval</span>: <span class="nc">row</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">?</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">ease_factor</span>: <span class="nc">row</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">?</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">taken_millis</span>: <span class="nc">row</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">7</span><span class="p">).</span><span class="n">unwrap_or_default</span><span class="p">(),</span><span class="w">
</span><span class="w"></span><span class="n">review_kind</span>: <span class="nc">row</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">8</span><span class="p">).</span><span class="n">unwrap_or_default</span><span class="p">(),</span><span class="w">
</span><span class="w"></span><span class="n">delta_t</span>: <span class="mi">0</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">i</span>: <span class="mi">0</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">r_history</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[],</span><span class="w">
</span><span class="w"></span><span class="n">t_history</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[],</span><span class="w">
</span><span class="w"></span><span class="p">})</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">read_collection</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Connection</span>::<span class="n">open</span><span class="p">(</span><span class="s">"tests/data/collection.anki21"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">filter_out_suspended_cards</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">filter_out_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec</span><span class="o">!</span><span class="p">[];</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">flags_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">filter_out_flags</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="w">
</span><span class="w"></span><span class="s">"AND flags NOT IN ({})"</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">filter_out_flags</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">", "</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="s">""</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">};</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">suspended_cards_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">filter_out_suspended_cards</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="s">"AND queue != -1"</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="s">""</span><span class="w">
</span><span class="w"></span><span class="p">};</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">current_timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Utc</span>::<span class="n">now</span><span class="p">().</span><span class="n">timestamp</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="w">
</span><span class="w"></span><span class="err">"</span><span class="n">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> 
</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span><span class="n">revlog</span><span class="w"> 
</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="o">!=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">OR</span><span class="w"> </span><span class="n">ivl</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="n">AND</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="w"> </span><span class="n">AND</span><span class="w"> </span><span class="n">cid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="w"> </span><span class="n">AND</span><span class="w"> </span><span class="n">cid</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="w"> </span><span class="n">SELECT</span><span class="w"> </span><span class="n">id</span><span class="w">
</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span><span class="n">cards</span><span class="w">
</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="w"> </span><span class="p">)</span><span class="err">"</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">current_timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">current_timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">suspended_cards_str</span><span class="p">,</span><span class="w"> </span><span class="n">flags_str</span><span class="w">
</span><span class="w"></span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">revlogs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">prepare_cached</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">query_and_then</span><span class="p">([],</span><span class="w"> </span><span class="n">row_to_revlog_entry</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;&gt;&gt;</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="n">revlogs</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">group_by_cid</span><span class="p">(</span><span class="n">revlogs</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">grouped</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashMap</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="n">revlog</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">revlogs</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">grouped</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">entry</span><span class="p">(</span><span class="n">revlog</span><span class="p">.</span><span class="n">cid</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">or_insert_with</span><span class="p">(</span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">revlog</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">grouped</span><span class="p">.</span><span class="n">into_iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="n">v</span><span class="p">).</span><span class="n">collect</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">convert_to_date</span><span class="p">(</span><span class="n">timestamp</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">next_day_starts_at</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">timezone</span>: <span class="nc">Tz</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">chrono</span>::<span class="n">NaiveDate</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">timestamp_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">next_day_starts_at</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3600</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// å‰ªå»æŒ‡å®šå°æ—¶æ•°
</span><span class="c1"></span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Utc</span><span class="p">.</span><span class="n">timestamp_millis_opt</span><span class="p">(</span><span class="n">timestamp_seconds</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">with_timezone</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timezone</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">datetime</span><span class="p">.</span><span class="n">date_naive</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">extract_time_series_feature</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">entries</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">next_day_starts_at</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">timezone</span>: <span class="nc">Tz</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="c1">// å¯»æ‰¾æœ€åä¸€ç»„è¿ç»­ review_kind = 0 çš„ç¬¬ä¸€ä¸ª RevlogEntry çš„ç´¢å¼•
</span><span class="c1"></span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">index_to_keep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entries</span><span class="p">.</span><span class="n">len</span><span class="p">();</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">while</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">i</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">review_kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">index_to_keep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">index_to_keep</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ‰¾åˆ°äº†è¿ç»­çš„ review_kind = 0 çš„ç»„ï¼Œé€€å‡ºå¾ªç¯
</span><span class="c1"></span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1">// åˆ é™¤æ­¤ RevlogEntry ä¹‹å‰çš„æ‰€æœ‰æ¡ç›®
</span><span class="c1"></span><span class="w"></span><span class="n">entries</span><span class="p">.</span><span class="n">drain</span><span class="p">(..</span><span class="n">index_to_keep</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1">// å»æ‰ review_kind = 4 çš„ RevlogEntry
</span><span class="c1"></span><span class="w"></span><span class="n">entries</span><span class="p">.</span><span class="n">retain</span><span class="p">(</span><span class="o">|</span><span class="n">entry</span><span class="o">|</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">review_kind</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1">// å»æ‰ review_kind = 3 ä¸” ease_factor = 0 çš„ RevlogEntry
</span><span class="c1"></span><span class="w"></span><span class="n">entries</span><span class="p">.</span><span class="n">retain</span><span class="p">(</span><span class="o">|</span><span class="n">entry</span><span class="o">|</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">review_kind</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">ease_factor</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1">// å°†æ‰€æœ‰ review_kind + 1
</span><span class="c1"></span><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">entry</span><span class="p">.</span><span class="n">review_kind</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1">// è½¬æ¢æ—¶é—´æˆ³å¹¶ä¿ç•™æ¯ä¸ªæ—¥æœŸçš„ç¬¬ä¸€ä¸ª RevlogEntry
</span><span class="c1"></span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">unique_dates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="n">HashSet</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="n">entries</span><span class="p">.</span><span class="n">retain</span><span class="p">(</span><span class="o">|</span><span class="n">entry</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">convert_to_date</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">next_day_starts_at</span><span class="p">,</span><span class="w"> </span><span class="n">timezone</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">unique_dates</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">});</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1">// è®¡ç®—å…¶ä½™ RevlogEntry çš„ delta_t
</span><span class="c1"></span><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="p">..</span><span class="n">entries</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">date_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">convert_to_date</span><span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">next_day_starts_at</span><span class="p">,</span><span class="w"> </span><span class="n">timezone</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">date_previous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">convert_to_date</span><span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">].</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">next_day_starts_at</span><span class="p">,</span><span class="w"> </span><span class="n">timezone</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">delta_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">date_current</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">date_previous</span><span class="p">).</span><span class="n">num_days</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1">// è®¡ç®— i, r_history, t_history
</span><span class="c1"></span><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="p">..</span><span class="n">entries</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// ä½ç½®ä» 1 å¼€å§‹
</span><span class="c1"></span><span class="w"></span><span class="c1">// é™¤äº†ç¬¬ä¸€ä¸ªæ¡ç›®ï¼Œå…¶ä½™æ¡ç›®å°†å‰é¢çš„ button_chosen å’Œ delta_t åŠ å…¥ r_history å’Œ t_history
</span><span class="c1"></span><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_history</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="n">i</span><span class="p">].</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">button_chosen</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">t_history</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="n">i</span><span class="p">].</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">delta_t</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1">// æ‰¾åˆ° review_kind = 0 ä¸”å‰ä¸€ä¸ª RevlogEntry çš„ review_kind æ˜¯ 1 æˆ– 2 çš„ RevlogEntryï¼Œç„¶ååˆ é™¤å…¶åŠå…¶ä¹‹åçš„æ‰€æœ‰ RevlogEntry
</span><span class="c1"></span><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">index_to_remove</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entries</span><span class="p">.</span><span class="n">windows</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">enumerate</span><span class="p">().</span><span class="n">find_map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">window</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">review_kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">review_kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">review_kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="nb">Some</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// è¿”å›ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ RevlogEntry çš„ç´¢å¼•
</span><span class="c1"></span><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="nb">None</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">})</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">entries</span><span class="p">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">index_to_remove</span><span class="p">);</span><span class="w"> </span><span class="c1">// æˆªå–ä» 0 åˆ° index_to_remove çš„éƒ¨åˆ†ï¼Œåˆ é™¤å…¶åçš„æ‰€æœ‰æ¡ç›®
</span><span class="c1"></span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">entries</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">convert_to_fsrs_items</span><span class="p">(</span><span class="n">revlogs</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">FSRSItem</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">revlogs</span><span class="p">.</span><span class="n">into_iter</span><span class="p">().</span><span class="n">flat_map</span><span class="p">(</span><span class="o">|</span><span class="n">group</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">group</span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="o">|</span><span class="n">entry</span><span class="o">|</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// è¿‡æ»¤æ‰ i = 1 çš„ RevlogEntry
</span><span class="c1"></span><span class="w"></span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">entry</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">FSRSItem</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">t_history</span>: <span class="nc">entry</span><span class="p">.</span><span class="n">t_history</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">r_history</span>: <span class="nc">entry</span><span class="p">.</span><span class="n">r_history</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">delta_t</span>: <span class="nc">entry</span><span class="p">.</span><span class="n">delta_t</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">label</span>: <span class="nc">match</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">button_chosen</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">panic</span><span class="o">!</span><span class="p">(</span><span class="s">"Unexpected value for button_chosen"</span><span class="p">),</span><span class="w">
</span><span class="w"></span><span class="p">},</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">})</span><span class="w">
</span><span class="w"></span><span class="p">}).</span><span class="n">collect</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">remove_non_learning_first</span><span class="p">(</span><span class="n">revlogs_per_card</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">revlogs_per_card</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">result</span><span class="p">.</span><span class="n">retain</span><span class="p">(</span><span class="o">|</span><span class="n">entries</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">first_entry</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entries</span><span class="p">.</span><span class="n">first</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">first_entry</span><span class="p">.</span><span class="n">review_kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="kc">false</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">});</span><span class="w">
</span><span class="w"></span><span class="n">result</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">anki_to_fsrs</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">FSRSItem</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">revlogs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_collection</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">revlogs_per_card</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group_by_cid</span><span class="p">(</span><span class="n">revlogs</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">extracted_revlogs_per_card</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">revlogs_per_card</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">entries</span><span class="o">|</span><span class="w"> </span><span class="n">extract_time_series_feature</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">Tz</span>::<span class="n">Asia__Shanghai</span><span class="p">))</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">collect</span><span class="p">();</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">filtered_revlogs_per_card</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remove_non_learning_first</span><span class="p">(</span><span class="n">extracted_revlogs_per_card</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">fsrs_items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">convert_to_fsrs_items</span><span class="p">(</span><span class="n">filtered_revlogs_per_card</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">fsrs_items</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cp">#[test]</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">revlogs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_collection</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="n">dbg</span><span class="o">!</span><span class="p">(</span><span class="n">revlogs</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">revlogs_per_card</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group_by_cid</span><span class="p">(</span><span class="n">revlogs</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">dbg</span><span class="o">!</span><span class="p">(</span><span class="n">revlogs_per_card</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">extracted_revlogs_per_card</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevlogEntry</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">revlogs_per_card</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">entries</span><span class="o">|</span><span class="w"> </span><span class="n">extract_time_series_feature</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">Tz</span>::<span class="n">Asia__Shanghai</span><span class="p">))</span><span class="w">
</span><span class="w"></span><span class="p">.</span><span class="n">collect</span><span class="p">();</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">dbg</span><span class="o">!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">extracted_revlogs_per_card</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w">
</span><span class="w"></span><span class="n">extracted_revlogs_per_card</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remove_non_learning_first</span><span class="p">(</span><span class="n">extracted_revlogs_per_card</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">dbg</span><span class="o">!</span><span class="p">(</span><span class="n">extracted_revlogs_per_card</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">len</span><span class="p">()).</span><span class="n">sum</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">());</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">fsrs_items</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">FSRSItem</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">convert_to_fsrs_items</span><span class="p">(</span><span class="n">extracted_revlogs_per_card</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">dbg</span><span class="o">!</span><span class="p">(</span><span class="n">fsrs_items</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div><p data-pid="jat3kS9p">ç›®å‰é¡¹ç›®å·²ç»å®Œæˆäº†ä» Anki çš„æ•°æ®åº“è¯»å–å¤ä¹ è®°å½•ï¼Œè½¬æ¢ä¸ºæ•°æ®é›†æ ·æœ¬ï¼Œè®­ç»ƒ FSRS æ¨¡å‹çš„æ•´ä¸ªæµç¨‹ã€‚ç¼–è¯‘å‡ºæ¥ä¹Ÿåªæœ‰åå‡  MBï¼Œæœªæ¥æœ‰æœ›æ•´åˆå…¥ Anki çš„ Rust åç«¯ï¼Œå®ç°åŒæ—¶åœ¨ PCã€iOS å’Œ Android ä¸‰ç«¯ä¸Šè·‘æœºå™¨å­¦ä¹ è®­ç»ƒã€‚</p><p data-pid="nBbEfvkq">ä¹Ÿæ¬¢è¿ Rust å¤§ä½¬æ¥æœ¬é¡¹ç›®è´¡çŒ®ä»£ç ï¼Œæ¨è¿›é—´éš”é‡å¤é¢†åŸŸçš„å‘å±•ï¼š</p><a class="wrap external" data-draft-node="block" data-draft-type="link-card" href="https://github.com/open-spaced-repetition/fsrs-optimizer-burn" rel="nofollow noreferrer noopener" target="_blank">open-spaced-repetition/fsrs-optimizer-burn: Rust-based Optimizer for FSRS (github.com)</a><p data-pid="fye122R3">æ›´å¤šæœ‰å…³ FSRS çš„ä»‹ç»ï¼Œè¯·è§ï¼š</p><a class="internal" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-337e676d732039a25471c1057c54bfa3_180x120.jpg" data-image-height="1480" data-image-width="2700" href="./577383961.html" rel="noopener noreferrer" target="_blank">å¶å³»å³£ï¼šKDD'22 | å¢¨å¢¨èƒŒå•è¯ï¼šåŸºäºæ—¶åºæ¨¡å‹ä¸æœ€ä¼˜æ§åˆ¶çš„è®°å¿†ç®—æ³• [AI+æ•™è‚²]</a><a class="internal" data-draft-node="block" data-draft-type="link-card" data-image="https://pic1.zhimg.com/v2-9c14ae073ac7ff2f3d208d31b0ed10b2_180x120.jpg" data-image-height="1304" data-image-width="2638" href="./649655080.html" rel="noopener noreferrer" target="_blank">å¶å³»å³£ï¼šè§£é‡Š FSRSï¼ˆä¸Šç¯‡ï¼‰ï¼šç®—æ³•æè¿°ä¸è¿ä½œåŸç†</a><a class="internal" data-draft-node="block" data-draft-type="link-card" data-image="https://pic4.zhimg.com/v2-e9f56ba072166b28b7c371e246a79fc5_180x120.jpg" data-image-height="1304" data-image-width="2638" href="./649701172.html" rel="noopener noreferrer" target="_blank">å¶å³»å³£ï¼šè§£é‡Š FSRSï¼ˆä¸‹ç¯‡ï¼‰ï¼šå‡†ç¡®åº¦</a><p></p>

<hr>
<p data-pagefind-ignore><a href="./">â† è¿”å›ç›®å½•</a></p>
</article>
<footer>
<p style="color: #999; font-size: 0.85em; text-align: center; margin-top: 2em;">
æœ¬é¡µé¢ç”± <a href="https://github.com/L-M-Sherlock/ZhiHuArchive" target="_blank" rel="noopener noreferrer">ZhiHuArchive</a> æ¸²æŸ“ï¼Œæ¨¡æ¿å‚è€ƒ <a href="https://github.com/frostming/fxzhihu" target="_blank" rel="noopener noreferrer">FxZhihu</a>ã€‚
</p>
</footer>
<script src="https://giscus.app/client.js"
data-repo="L-M-Sherlock/ZhiHuArchive"
data-repo-id="MDEwOlJlcG9zaXRvcnkzNDk5NDE0MzM="
data-category="Announcements"
data-category-id="DIC_kwDOFNuuuc4Ck92x"
data-mapping="title"
data-strict="0"
data-reactions-enabled="1"
data-emit-metadata="0"
data-input-position="top"
data-theme="preferred_color_scheme"
data-lang="zh-CN"
data-loading="lazy"
crossorigin="anonymous"
async>
</script>
</body>
</html>