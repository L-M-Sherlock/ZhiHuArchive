<meta charset="UTF-8">
如何不使用Anki创建apkg格式牌组?
<p data-pid="0vEApRlZ">Anki 代码是开源的，题主学计算机的可以自己看一下哦[滑稽]</p><p data-pid="ozr0PDSe">代码如下</p><div class="highlight"><pre><code class="language-python3"><span></span><span class="c1"># Packaged Anki decks</span>
<span class="c1">######################################################################</span>


<span class="k">class</span> <span class="nc">AnkiPackageExporter</span><span class="p">(</span><span class="n">AnkiExporter</span><span class="p">):</span>

    <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">"Anki Deck Package"</span><span class="p">)</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="s2">".apkg"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="n">Collection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">AnkiExporter</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">exportInto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># open a zip file</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">,</span> <span class="n">allowZip64</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">media</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doExport</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="c1"># media map</span>
        <span class="n">z</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s2">"media"</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">media</span><span class="p">))</span>
        <span class="n">z</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">doExport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">ZipFile</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>  <span class="c1"># type: ignore</span>
        <span class="c1"># export into the anki2 file</span>
        <span class="n">colfile</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">".apkg"</span><span class="p">,</span> <span class="s2">".anki2"</span><span class="p">)</span>
        <span class="n">AnkiExporter</span><span class="o">.</span><span class="n">exportInto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v2sched</span><span class="p">:</span>
            <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">colfile</span><span class="p">,</span> <span class="s2">"collection.anki2"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># prevent older clients from accessing</span>
            <span class="c1"># pylint: disable=unreachable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addDummyCollection</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">colfile</span><span class="p">,</span> <span class="s2">"collection.anki21"</span><span class="p">)</span>

        <span class="c1"># and media</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepareMedia</span><span class="p">()</span>
        <span class="n">media</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exportMedia</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mediaFiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mediaDir</span><span class="p">)</span>
        <span class="c1"># tidy up intermediate files</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">colfile</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">".apkg"</span><span class="p">,</span> <span class="s2">".media.db2"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mediaDir</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">".apkg"</span><span class="p">,</span> <span class="s2">".media"</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">media</span>

    <span class="k">def</span> <span class="nf">_exportMedia</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">ZipFile</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">fdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">media</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">cStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">mpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fdir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">mpath</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mpath</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\.svg$"</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">cStr</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mpath</span><span class="p">,</span> <span class="n">cStr</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_STORED</span><span class="p">)</span>
                <span class="n">media</span><span class="p">[</span><span class="n">cStr</span><span class="p">]</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s2">"NFC"</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">hooks</span><span class="o">.</span><span class="n">media_files_did_export</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">media</span>

    <span class="k">def</span> <span class="nf">prepareMedia</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># chance to move each file in self.mediaFiles into place before media</span>
        <span class="c1"># is zipped up</span>
        <span class="k">pass</span>

    <span class="c1"># create a dummy collection to ensure older clients don't try to read</span>
    <span class="c1"># data they don't understand</span>
    <span class="k">def</span> <span class="nf">_addDummyCollection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">zip</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">namedtmp</span><span class="p">(</span><span class="s2">"dummy.anki2"</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">newNote</span><span class="p">()</span>
        <span class="n">n</span><span class="p">[</span><span class="n">_</span><span class="p">(</span><span class="s2">"Front"</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">"This file requires a newer version of Anki."</span>
        <span class="n">c</span><span class="o">.</span><span class="n">addNote</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">downgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">zip</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"collection.anki2"</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div><p data-pid="-GzNdiqU">分析代码我们就能看出，其实 apkg 文件是一个压缩包，里面有关于卡片信息的数据库和媒体文件。</p><p data-pid="j2WUyasm">我们用 7z 来打开一下 .apkg 文件：</p><figure data-size="normal"><img src="https://pic2.zhimg.com/v2-b0373c553398a61da5f7fef706b94ee2_720w.jpg?source=3af55fa1" data-caption="" data-size="normal" data-rawwidth="1417" data-rawheight="283" data-default-watermark-src="https://pic1.zhimg.com/v2-be1eec9a4f41d79e65787fa79cdb52ff_720w.jpg?source=3af55fa1" class="origin_image zh-lightbox-thumb" width="1417" data-original="https://pic1.zhimg.com/v2-b0373c553398a61da5f7fef706b94ee2_r.jpg?source=3af55fa1"></figure><p data-pid="7CaSAaWI">其中，.anki2 的文件就是一个 SQLite 数据库，我们可以用 DB Browser for SQLite 打开看看：</p><figure data-size="normal"><img src="https://pic1.zhimg.com/v2-6bfb01135d694a69aecdf9685f032074_720w.jpg?source=3af55fa1" data-caption="" data-size="normal" data-rawwidth="1019" data-rawheight="625" data-default-watermark-src="https://pic1.zhimg.com/v2-55ed434a0de4616bda12f62850bed903_720w.jpg?source=3af55fa1" class="origin_image zh-lightbox-thumb" width="1019" data-original="https://pic2.zhimg.com/v2-6bfb01135d694a69aecdf9685f032074_r.jpg?source=3af55fa1"></figure><p data-pid="HE6YiCwB">其中，cards 这个表就是卡片信息，notes 表是笔记信息：</p><figure data-size="normal"><img src="https://pic1.zhimg.com/v2-10db7d023ca2ce1ae045a2f0d2fdb3aa_720w.jpg?source=3af55fa1" data-caption="" data-size="normal" data-rawwidth="1499" data-rawheight="568" data-default-watermark-src="https://pic1.zhimg.com/v2-42220ce6e2f20a129f22f3e3449e7991_720w.jpg?source=3af55fa1" class="origin_image zh-lightbox-thumb" width="1499" data-original="https://pic2.zhimg.com/v2-10db7d023ca2ce1ae045a2f0d2fdb3aa_r.jpg?source=3af55fa1"></figure><figure data-size="normal"><img src="https://pica.zhimg.com/v2-b3e04cca1e5806559be9235e256d1d08_720w.jpg?source=3af55fa1" data-caption="" data-size="normal" data-rawwidth="1074" data-rawheight="519" data-default-watermark-src="https://pic1.zhimg.com/v2-85442904f24e0b52e78a908e3638d681_720w.jpg?source=3af55fa1" class="origin_image zh-lightbox-thumb" width="1074" data-original="https://pic3.zhimg.com/v2-b3e04cca1e5806559be9235e256d1d08_r.jpg?source=3af55fa1"></figure><p data-pid="TaOw1Re7">然后我们回归正题，如何不用 Anki 创建 apkg 格式的牌组呢？</p><p data-pid="XZhyMae3">首先需要创建一个和 Anki2 格式相对应的 SQLite 的数据库，然后用 zip 格式压缩，最后把后缀改成 apkg 即可。</p><p data-pid="G2L3v-Cl">（当然，这是比较笼统的说法，具体做法请研究 Anki 的源码。</p><p data-pid="2rH-TBn9">2020/8/4 更新：</p><a href="http://link.zhihu.com/?target=https%3A//github.com/ankidroid/Anki-Android/wiki/Database-Structure" data-draft-node="block" data-draft-type="link-card" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/ankidroid/An</span><span class="invisible">ki-Android/wiki/Database-Structure</span><span class="ellipsis"></span></a><p data-pid="YyfZ26JI">最近在研究 Anki 学习数据，这个数据库的文档帮大忙了。 <a class="member_mention" href="http://www.zhihu.com/people/9738c822b4f758fd6162b6f97622fa42" data-hash="9738c822b4f758fd6162b6f97622fa42" data-hovercard="p$b$9738c822b4f758fd6162b6f97622fa42">@小石子</a> 感兴趣可以来看一下。</p>
1596509890