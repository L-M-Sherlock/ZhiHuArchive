<meta charset="UTF-8">
HITszQAbot 迁移记录
<div><blockquote>本文使用 <a class="internal" href="https://zhuanlan.zhihu.com/p/106057556">Zhihu On VSCode</a> 创作并发布</blockquote><h2>前情提要</h2><p>在大一大二期间维护招生机器人小哈也算我的一项业余爱好，这个项目的具体内容请见：</p><a class="LinkCard new" data-draft-node="block" data-draft-type="link-card" data-image="https://pic3.zhimg.com/v2-fb73f360458689913573e39efefd6e46_180x120.jpg" data-image-height="1015" data-image-width="1920" data-text="叶峻峣：HITszQAbot 项目记录" href="https://zhuanlan.zhihu.com/p/158186707" target="_blank"><span><span></span><span></span></span><span></span></a><p>然而去年暑假 TX 杀了一批 qq 机器人，小哈所依赖的酷Q也未能幸免于难：</p><a class="LinkCard new" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-55134e6715722766cefb7545c5f434d5_ipico.jpg" data-image-height="746" data-image-width="651" data-text="如何看待继晨风机器人后，各机器人宣布关闭？" href="https://www.zhihu.com/question/411468332/answer/1378155870" target="_blank"><span><span></span><span></span></span><span></span></a><p>介于当时招生活动已经进入尾声，我也没有太多精力将小哈的依赖转移到其它 qq 机器人（似乎那个时候只有 mirai 存活）。</p><p>大半年过去了，一年一度的招生季又要来了，我也正好抽空看看有没有较好的迁移方案。</p><p>这次我选择了 nonebot 的升级版——<a class="wrap external" href="https://v2.nonebot.dev/" rel="nofollow noreferrer" target="_blank">nonebot2</a> 作为 qq 机器人开发框架，<a class="wrap external" href="https://github.com/Mrs4s/go-cqhttp" rel="nofollow noreferrer" target="_blank">go-cqhttp</a> 作为 qq 机器人客户端，实现招生问答功能。</p><p>代码在文末。</p><h2>配置 go-cqhttp</h2><p>总之首先要访问一下 <a class="wrap external" href="https://github.com/Mrs4s/go-cqhttp" rel="nofollow noreferrer" target="_blank">go-cqhttp</a>，去 release 里下载对应版本的安装包，我是直接在 windows 上测试的，所以就下载了 <a class="wrap external" href="https://github.com/Mrs4s/go-cqhttp/releases/download/v1.0.0-beta2/go-cqhttp_windows_amd64.exe" rel="nofollow noreferrer" target="_blank">go-cqhttp_windows_amd64.exe</a>。</p><p>建一个文件夹，把 exe 文件放进去，执行一下，具体安装方法请见：</p><a class="LinkCard new" data-draft-node="block" data-draft-type="link-card" data-text="开始 | go-cqhttp 帮助中心" href="https://docs.go-cqhttp.org/guide/quick_start.html" target="_blank"><span><span></span><span></span></span><span></span></a><p>搞定后应该是这样的：</p><p><br/></p><figure><img class="content_image lazy" data-actualsrc="https://pic1.zhimg.com/v2-b68f34b037794cbb286441fc86deecb4_b.png" data-size="normal" src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='0' height='0'&gt;&lt;/svg&gt;"/><figcaption>Image</figcaption></figure><p><br/></p><p>config.yml 具体怎么配下面有说。</p><h2>从 NoneBot 迁移到 NoneBot2</h2><p>由于 NoneBot2 和 NoneBot 的主体差异不大，理论上把 NoneBot 的插件搬过去，稍微改亿点点就行了。我选择直接用 NoneBot2 的 nb-cli 新建一个项目，然后开始复用以前写的代码。</p><p>NoneBot2 具体怎么安装，请见：<a class="external" href="https://v2.nonebot.dev/guide/" rel="nofollow noreferrer" target="_blank"><span>https://</span><span>v2.nonebot.dev/guide/</span><span></span></a></p><p>这里要注意的是，由于我选择 go-cqhttp 作为 qq 客户端，所以 NoneBot2 这里要用 CQHTTP 适配器。详情见：<a class="external" href="https://v2.nonebot.dev/guide/cqhttp-guide.html" rel="nofollow noreferrer" target="_blank"><span>https://</span><span>v2.nonebot.dev/guide/cq</span><span>http-guide.html</span><span></span></a>，里面也说明了 config.yml 如何配置。</p><p>这里重点说一下迁移中我改了啥：</p><p>NoneBot：</p><div><pre><code><span>from</span> <span>nonebot</span> <span>import</span> <span>on_command</span><span>,</span> <span>CommandSession</span>
<span>from</span> <span>nonebot</span> <span>import</span> <span>on_natural_language</span><span>,</span> <span>NLPSession</span><span>,</span> <span>IntentCommand</span>
<span>from</span> <span>nonebot.helpers</span> <span>import</span> <span>context_id</span><span>,</span> <span>render_expression</span>
</code></pre></div><p>在之前的 NoneBot 里，有一个专用的自然语言处理模块，但是 NoneBot2 里它没了。于是我把它们换成了：</p><div><pre><code><span>from</span> <span>nonebot</span> <span>import</span> <span>on_command</span>
<span>from</span> <span>nonebot.rule</span> <span>import</span> <span>to_me</span>
<span>from</span> <span>nonebot.typing</span> <span>import</span> <span>T_State</span>
<span>from</span> <span>nonebot.adapters</span> <span>import</span> <span>Bot</span><span>,</span> <span>Event</span>
<span>import</span> <span>nonebot.adapters.cqhttp.message</span> <span>as</span> <span>message</span>
</code></pre></div><p>这样可能很不直观，我简单说说哪些功能的函数被替换了：</p><div><pre><code><span>@on_command</span><span>(</span><span>'faq_local'</span><span>)</span>
<span>async</span> <span>def</span> <span>faq_local</span><span>(</span><span>session</span><span>:</span> <span>CommandSession</span><span>):</span>
    <span>raw_question</span> <span>=</span> <span>session</span><span>.</span><span>state</span><span>.</span><span>get</span><span>(</span><span>'message'</span><span>)</span>
<span># 替换为</span>
<span>@faq.handle</span><span>()</span>
<span>async</span> <span>def</span> <span>faq_local</span><span>(</span><span>event</span><span>:</span> <span>Event</span><span>):</span>
    <span>raw_question</span> <span>=</span> <span>str</span><span>(</span><span>event</span><span>.</span><span>get_message</span><span>())</span>
    
<span>reply</span> <span>=</span> <span>add_at</span><span>(</span><span>reply</span><span>,</span> <span>session</span><span>.</span><span>ctx</span><span>.</span><span>get</span><span>(</span><span>'user_id'</span><span>))</span>
<span>session</span><span>.</span><span>send</span><span>(</span><span>reply</span><span>)</span>
<span># 替换为</span>
<span>reply</span> <span>=</span> <span>add_at</span><span>(</span><span>reply</span><span>,</span> <span>event</span><span>.</span><span>get_user_id</span><span>())</span>
<span>faq</span><span>.</span><span>send</span><span>(</span><span>message</span><span>.</span><span>Message</span><span>(</span><span>reply</span><span>))</span> <span>#这里有坑，不用 Message 构造回复会使 CQ 码失效</span>
</code></pre></div><p>具体怎么替换，还是建议多看看<a class="external" href="https://v2.nonebot.dev/api/" rel="nofollow noreferrer" target="_blank"><span>https://</span><span>v2.nonebot.dev/api/</span><span></span></a>，api 熟悉了就方便实现旧功能。</p><h2>测试</h2><p>左边是 NoneBot，右边是 go-cqhttp</p><figure><img class="origin_image zh-lightbox-thumb lazy" data-actualsrc="https://pic3.zhimg.com/v2-8e83d05108149f70fb60b3b1eb2fd10e_b.jpg" data-caption="" src="https://pic3.zhimg.com/v2-8e83d05108149f70fb60b3b1eb2fd10e_r.jpg" data-rawheight="1080" data-rawwidth="1920" data-size="normal" src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1920' height='1080'&gt;&lt;/svg&gt;" width="1920"/></figure><p>那个小哈它又回来啦！</p><figure><img class="content_image lazy" data-actualsrc="https://pic1.zhimg.com/v2-717145dd4dbbe2b1de607f145c9483f4_b.png" data-size="normal" src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='0' height='0'&gt;&lt;/svg&gt;"/><figcaption>Image</figcaption></figure><h2>结语</h2><p>由于迁移挺仓促的，有很多坑都还没填，凑合用用，代码已经传到 GitHub 了，想学习的可以随便拿去看看：</p><a class="LinkCard new" data-draft-node="block" data-draft-type="link-card" data-text="https://github.com/L-M-Sherlock/HITszQAbot" href="https://github.com/L-M-Sherlock/HITszQAbot" target="_blank"><span><span></span><span></span></span><span></span></a><p>具体怎么部署我会慢慢更到 README 里面，先摸了。</p></div>