<!DOCTYPE html>
<html lang="zh-CN">
<head>
<title>HITszQAbot 迁移记录 - @Thoughts Memo</title>
<meta charset="UTF-8">
<meta property="og:type" content="website">
<meta property="og:title" content="HITszQAbot 迁移记录 - @Thoughts Memo">
<meta property="og:site_name" content="ZhiHu Archive for Thoughts Memo">
<meta property="og:url" content="https://zhuanlan.zhihu.com/p/363342119">
<meta name="description" property="og:description" content="本文使用 Zhihu On VSCode 创作并发布前情提要在大一大二期间维护招生机器人小哈也…">
<meta property="twitter:card" content="summary">
<meta name="twitter:title" property="og:title" itemprop="name" content="HITszQAbot 迁移记录 - @Thoughts Memo">
<meta name="twitter:description" property="og:description" itemprop="description" content="本文使用 Zhihu On VSCode 创作并发布前情提要在大一大二期间维护招生机器人小哈也…">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<meta name="google-site-verification" content="U7ZAFUgGNK60mmMqaRygg5vy-k8pwbPbDFXNjDCu7Xk" />
<link rel="alternate" type="application/rss+xml" title="ZhiHu Archive for Thoughts Memo" href="https://l-m-sherlock.github.io/ZhiHuArchive/feed.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/yue.css@0.4.0/yue.css">
<script>
</script>
<style>
.origin_image {
width: 100%;
}
figure {
margin:1.4em 0;
}
figure img {
width: 100%;
}
img {
vertical-align: middle;
}
.author {
display: flex;
gap: 1em;
}
#avatar {
width: 100px;
height: 100px;
}
.author > div {
flex: 1;
}
a[data-draft-type="link-card"] {
   display: block;
}
</style>
</head>
<body style="max-width: 1000px; margin: 0 auto; padding: 0 1em 0 1em;" class="yue">
<p><a href="./">← 返回目录</a></p>
<hr>
<header>
<img class="origin_image" src="https://picx.zhimg.com/v2-eb4aa092b951a4ac67e12fdcec61d733_720w.jpg?source=b1748391"/>
<h1><a href="https://zhuanlan.zhihu.com/p/363342119">HITszQAbot 迁移记录</a></h1>
<div class="author">
<img class="avatar" id="avatar" src="https://pica.zhimg.com/50/v2-f958f2b875b0cf4d7ee853e4446ba2d1_l.jpg?source=b1748391" />
<div>
<h2 rel="author">
<a href="https://api.zhihu.com/people/4c592f496dc33822b560b382907ff1d0" target="_blank">@Thoughts Memo</a>
</h2>
<p> 学校≠教育≠技能；文凭溢价=80%信号传递+20%人力资本 </p>
</div>
</div>
<time datetime="2021-04-08T13:35:01">发表于 2021年04月08日</time>
<p rel="stats"style="color: #999; font-size: 0.9em;">16 👍 / 5 💬</p>
</header>
<article>
<blockquote data-pid="BWNdglR7">本文使用 <a class="internal" href="https://zhuanlan.zhihu.com/p/106057556">Zhihu On VSCode</a> 创作并发布</blockquote><h2>前情提要</h2><p data-pid="tBn2vxKw">在大一大二期间维护招生机器人小哈也算我的一项业余爱好，这个项目的具体内容请见：</p><a class="internal" data-draft-node="block" data-draft-type="link-card" data-image="https://pica.zhimg.com/v2-fb73f360458689913573e39efefd6e46_180x120.jpg" data-image-height="1015" data-image-width="1920" href="./158186707.html">叶峻峣：HITszQAbot 项目记录</a><p data-pid="i9MEFh81">然而去年暑假 TX 杀了一批 qq 机器人，小哈所依赖的酷Q也未能幸免于难：</p><a class="internal" data-draft-node="block" data-draft-type="link-card" data-image="https://picx.zhimg.com/v2-55134e6715722766cefb7545c5f434d5_ipico.jpg" data-image-height="746" data-image-width="651" href="./1378155870.html">如何看待继晨风机器人后，各机器人宣布关闭？</a><p data-pid="LCI1t7KA">介于当时招生活动已经进入尾声，我也没有太多精力将小哈的依赖转移到其它 qq 机器人（似乎那个时候只有 mirai 存活）。</p><p data-pid="YqtfdGPa">大半年过去了，一年一度的招生季又要来了，我也正好抽空看看有没有较好的迁移方案。</p><p data-pid="92URRgRq">这次我选择了 nonebot 的升级版——<a class="wrap external" href="https://v2.nonebot.dev/" rel="nofollow noreferrer" target="_blank">nonebot2</a> 作为 qq 机器人开发框架，<a class="wrap external" href="https://github.com/Mrs4s/go-cqhttp" rel="nofollow noreferrer" target="_blank">go-cqhttp</a> 作为 qq 机器人客户端，实现招生问答功能。</p><p data-pid="C8wJ-1F9">代码在文末。</p><h2>配置 go-cqhttp</h2><p data-pid="umt341ZH">总之首先要访问一下 <a class="wrap external" href="https://github.com/Mrs4s/go-cqhttp" rel="nofollow noreferrer" target="_blank">go-cqhttp</a>，去 release 里下载对应版本的安装包，我是直接在 windows 上测试的，所以就下载了 <a class="wrap external" href="https://github.com/Mrs4s/go-cqhttp/releases/download/v1.0.0-beta2/go-cqhttp_windows_amd64.exe" rel="nofollow noreferrer" target="_blank">go-cqhttp_windows_amd64.exe</a>。</p><p data-pid="KtnaFOC9">建一个文件夹，把 exe 文件放进去，执行一下，具体安装方法请见：</p><a class="wrap external" data-draft-node="block" data-draft-type="link-card" href="https://docs.go-cqhttp.org/guide/quick_start.html" rel="nofollow noreferrer" target="_blank">开始 | go-cqhttp 帮助中心</a><p data-pid="d5cKekyd">搞定后应该是这样的：</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><img class="content_image" data-original-token="v2-b68f34b037794cbb286441fc86deecb4" data-size="normal" src="https://pica.zhimg.com/v2-b68f34b037794cbb286441fc86deecb4_b.png"/><figcaption>Image</figcaption></figure><p class="ztext-empty-paragraph"><br/></p><p data-pid="C6Q9mp9I">config.yml 具体怎么配下面有说。</p><h2>从 NoneBot 迁移到 NoneBot2</h2><p data-pid="FQznl4C2">由于 NoneBot2 和 NoneBot 的主体差异不大，理论上把 NoneBot 的插件搬过去，稍微改亿点点就行了。我选择直接用 NoneBot2 的 nb-cli 新建一个项目，然后开始复用以前写的代码。</p><p data-pid="OPAEeLV8">NoneBot2 具体怎么安装，请见：<a class="external" href="https://v2.nonebot.dev/guide/" rel="nofollow noreferrer" target="_blank"><span class="invisible">https://</span><span class="visible">v2.nonebot.dev/guide/</span><span class="invisible"></span></a></p><p data-pid="4qhg4m4i">这里要注意的是，由于我选择 go-cqhttp 作为 qq 客户端，所以 NoneBot2 这里要用 CQHTTP 适配器。详情见：<a class="external" href="https://v2.nonebot.dev/guide/cqhttp-guide.html" rel="nofollow noreferrer" target="_blank"><span class="invisible">https://</span><span class="visible">v2.nonebot.dev/guide/cq</span><span class="invisible">http-guide.html</span><span class="ellipsis"></span></a>，里面也说明了 config.yml 如何配置。</p><p data-pid="RUjsXc-i">这里重点说一下迁移中我改了啥：</p><p data-pid="ZowfrpV_">NoneBot：</p><div class="highlight"><pre><code class="language-python"><span class="kn">from</span> <span class="nn">nonebot</span> <span class="kn">import</span> <span class="n">on_command</span><span class="p">,</span> <span class="n">CommandSession</span>
<span class="kn">from</span> <span class="nn">nonebot</span> <span class="kn">import</span> <span class="n">on_natural_language</span><span class="p">,</span> <span class="n">NLPSession</span><span class="p">,</span> <span class="n">IntentCommand</span>
<span class="kn">from</span> <span class="nn">nonebot.helpers</span> <span class="kn">import</span> <span class="n">context_id</span><span class="p">,</span> <span class="n">render_expression</span>
</code></pre></div><p data-pid="JmrIAEc9">在之前的 NoneBot 里，有一个专用的自然语言处理模块，但是 NoneBot2 里它没了。于是我把它们换成了：</p><div class="highlight"><pre><code class="language-python"><span class="kn">from</span> <span class="nn">nonebot</span> <span class="kn">import</span> <span class="n">on_command</span>
<span class="kn">from</span> <span class="nn">nonebot.rule</span> <span class="kn">import</span> <span class="n">to_me</span>
<span class="kn">from</span> <span class="nn">nonebot.typing</span> <span class="kn">import</span> <span class="n">T_State</span>
<span class="kn">from</span> <span class="nn">nonebot.adapters</span> <span class="kn">import</span> <span class="n">Bot</span><span class="p">,</span> <span class="n">Event</span>
<span class="kn">import</span> <span class="nn">nonebot.adapters.cqhttp.message</span> <span class="kn">as</span> <span class="nn">message</span>
</code></pre></div><p data-pid="B0ecplon">这样可能很不直观，我简单说说哪些功能的函数被替换了：</p><div class="highlight"><pre><code class="language-python"><span class="nd">@on_command</span><span class="p">(</span><span class="s1">'faq_local'</span><span class="p">)</span>
<span class="n">async</span> <span class="k">def</span> <span class="nf">faq_local</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">CommandSession</span><span class="p">):</span>
<span class="n">raw_question</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'message'</span><span class="p">)</span>
<span class="c1"># 替换为</span>
<span class="nd">@faq.handle</span><span class="p">()</span>
<span class="n">async</span> <span class="k">def</span> <span class="nf">faq_local</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">):</span>
<span class="n">raw_question</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">get_message</span><span class="p">())</span>

<span class="n">reply</span> <span class="o">=</span> <span class="n">add_at</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'user_id'</span><span class="p">))</span>
<span class="n">session</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
<span class="c1"># 替换为</span>
<span class="n">reply</span> <span class="o">=</span> <span class="n">add_at</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">())</span>
<span class="n">faq</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span> <span class="c1">#这里有坑，不用 Message 构造回复会使 CQ 码失效</span>
</code></pre></div><p data-pid="iMSvDbWT">具体怎么替换，还是建议多看看<a class="external" href="https://v2.nonebot.dev/api/" rel="nofollow noreferrer" target="_blank"><span class="invisible">https://</span><span class="visible">v2.nonebot.dev/api/</span><span class="invisible"></span></a>，api 熟悉了就方便实现旧功能。</p><h2>测试</h2><p data-pid="lSj1-hOA">左边是 NoneBot，右边是 go-cqhttp</p><figure data-size="normal"><img class="origin_image zh-lightbox-thumb" data-caption="" data-original="https://pica.zhimg.com/v2-8e83d05108149f70fb60b3b1eb2fd10e_r.jpg" data-original-token="v2-d60970875508d141584ef638799a0f75" data-rawheight="1080" data-rawwidth="1920" data-size="normal" src="https://pica.zhimg.com/v2-8e83d05108149f70fb60b3b1eb2fd10e_b.jpg" width="1920"/></figure><p data-pid="L3jbuMEJ">那个小哈它又回来啦！</p><figure data-size="normal"><img class="content_image" data-original-token="v2-717145dd4dbbe2b1de607f145c9483f4" data-size="normal" src="https://pica.zhimg.com/v2-717145dd4dbbe2b1de607f145c9483f4_b.png"/><figcaption>Image</figcaption></figure><h2>结语</h2><p data-pid="fcbTUoMC">由于迁移挺仓促的，有很多坑都还没填，凑合用用，代码已经传到 GitHub 了，想学习的可以随便拿去看看：</p><a class="external" data-draft-node="block" data-draft-type="link-card" href="https://github.com/L-M-Sherlock/HITszQAbot" rel="nofollow noreferrer" target="_blank"><span class="invisible">https://</span><span class="visible">github.com/L-M-Sherlock</span><span class="invisible">/HITszQAbot</span><span class="ellipsis"></span></a><p data-pid="nJklSALv">具体怎么部署我会慢慢更到 README 里面，先摸了。</p>

<hr>
<div class="column" style="margin: 1em 0; padding: 0.5em 1em; border: 2px solid #999; border-radius: 5px;">
<h2>专栏：Thoughts Memo的文章</h2>
</div>
<hr>
<p><a href="./">← 返回目录</a></p>
</article>
<script src="https://giscus.app/client.js"
data-repo="L-M-Sherlock/ZhiHuArchive"
data-repo-id="MDEwOlJlcG9zaXRvcnkzNDk5NDE0MzM="
data-category="Announcements"
data-category-id="DIC_kwDOFNuuuc4Ck92x"
data-mapping="title"
data-strict="0"
data-reactions-enabled="1"
data-emit-metadata="0"
data-input-position="top"
data-theme="preferred_color_scheme"
data-lang="zh-CN"
data-loading="lazy"
crossorigin="anonymous"
async>
</script>
</body>
</html>